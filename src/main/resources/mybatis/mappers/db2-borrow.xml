<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.baron.member.sqlModel">

	<!-- 구매요청, 대여 관련 커리 -->

	<insert id="requestBook" parameterType="BookModel">
		INSERT INTO BOOKREQ
		(id,
		requestdate,
		bookname,book_cd,
		pricesales,writer,quantity,genre,link,
		imageurl, isbn, publisher,
		summary)
		VALUES
		(#{id},
		now(),#{bookname},#{book_cd},#{priceSales},#{writer},#{quantity},#{genre},#{link},#{imageurl},#{isbn},
		#{publisher}, #{summary})
	</insert>

	<update id="deleteRequest" parameterType="BookModel">
		UPDATE BOOKREQ
		SET
		book_cd='0'
		WHERE book_cd=#{book_cd}
	</update>

	<select id="requestList" resultType="BookModel">
		SELECT *
		FROM
		BOOKREQ AS
		A,
		BOOKMEMBER AS B
		WHERE A.id=B.id AND A.book_cd!='0'
		ORDER BY
		A.requestdate
		DESC
	</select>

	<select id="requestRecord" parameterType="String" resultType="BookModel">
		SELECT *
		FROM
		BOOKREQ AS A

		WHERE A.id=#{id} AND A.book_cd='0' AND
		(A.requestdate
		BETWEEN
		date_sub(NOW(),
		interval 365
		day) AND NOW())
		ORDER
		BY
		A.requestdate
		DESC
	</select>

	<select id="selectRequest" parameterType="String" resultType="BookModel">
		SELECT *
		FROM BOOKREQ
		WHERE book_cd=#{book_cd}

	</select>



	<!-- 대여관련 쿼리 -->
	<select id="borrowListAll" resultType="BookModel">
		SELECT * FROM BOOKMST AS
		A,
		BOOKRENT AS B
		WHERE B.rentchk=1 AND A.book_cd=B.book_cd
		ORDER BY
		B.rentdate DESC
	</select>

	<select id="borrowList" resultType="BookModel" parameterType="String">
		SELECT *
		FROM BOOKMST AS A, BOOKRENT AS B
		WHERE B.id = #{id} AND
		(B.rentchk='1' OR B.rentchk='2') AND
		A.book_cd=B.book_cd
		ORDER BY
		B.rentdate DESC
	</select>

	<insert id="borrowBook1" parameterType="BookModel">
		INSERT INTO
		BOOKRENT
		(book_cd, rentdate, returndate, rentchk, id)
		VALUES(#{book_cd}, now(),
		date_add(now(), interval +20 day),
		1, #{id})
	</insert>

	<update id="borrowBook2" parameterType="String">
		UPDATE
		BOOKMST
		SET
		rentchk='1'
		WHERE book_cd=#{book_cd}
	</update>

	<update id="stopBorrow" parameterType="String">
		UPDATE BOOKMST A
		,BOOKRENT
		B
		SET
		A.rentchk='4'
		WHERE
		A.book_cd=#{book_cd} AND A.rentchk='0'

	</update>

	<update id="recoverBook" parameterType="String">
		UPDATE BOOKMST A
		SET
		A.rentchk='0'
		WHERE
		A.book_cd=#{book_cd} AND A.rentchk='4'

	</update>
	<update id="confirmBorrowBook" parameterType="String">
		UPDATE BOOKMST A
		INNER
		JOIN BOOKRENT B
		ON A.rentchk = B.rentchk
		SET
		A.rentchk='2',
		B.rentchk='2',
		B.rentdate=NOW()
		WHERE
		A.book_cd=#{book_cd} AND
		B.book_cd=#{book_cd}

	</update>

	<update id="upPoint" parameterType="String">
		UPDATE BOOKMEMBER SET
		numborrow =
		numborrow + 1
		WHERE id = #{id}
	</update>

	<update id="returnBook" parameterType="String">
		UPDATE BOOKMST A INNER
		JOIN
		BOOKRENT B
		ON A.rentchk = B.rentchk
		SET
		A.rentchk='0',
		B.rentchk='3',
		B.returndate=NOW()
		WHERE
		A.book_cd=#{book_cd} AND
		B.book_cd=#{book_cd}
	</update>
	<!-- <update id="confirmReturnBook" parameterType="String"> UPDATE BOOKMST 
		A INNER JOIN BOOKRENT B ON A.rentchk = B.rentchk SET A.rentchk='0', B.rentchk='0' 
		WHERE A.book_cd=#{book_cd} AND B.book_cd=#{book_cd} </update> -->
	<select id="returnListAll" resultType="BookModel">
		SELECT *
		FROM BOOKMST AS A,
		BOOKRENT AS B
		WHERE B.rentchk=3 AND A.book_cd=B.book_cd
	</select>

	<update id="extendBorrowBook" parameterType="String">
		UPDATE BOOKRENT
		SET
		returndate = date_add(now(), interval +20 day)
		WHERE
		book_cd=#{book_cd}
		AND rentchk='2'
	</update>

	<update id="cancelBorrowBook" parameterType="String">
		UPDATE BOOKMST
		SET
		rentchk='0'
		WHERE
		book_cd=#{book_cd} AND rentchk='1'
	</update>

	<delete id="deleteBorrowBook" parameterType="BookModel">
		DELETE FROM
		BOOKRENT
		WHERE book_cd=#{book_cd} AND id=#{id}
	</delete>

	<select id="rentListAll" parameterType="String" resultType="BookModel">
		SELECT * FROM BOOKMST AS A, BOOKRENT AS B
		WHERE
		A.book_cd=B.book_cd AND
		B.rentchk='2'
		ORDER BY
		B.rentdate
		DESC
	</select>


	<!-- <![CDATA[B.returndate > NOW()]]> -->

	<!-- <delete id="deleteRecord" parameterType="String"> DELETE ON BOOKRENT 
		WHERE DELETE ON reserve WHERE id=#{id} AND book_cd=#{book_cd} </delete> -->
	<select id="recordList" parameterType="String" resultType="BookModel">
		SELECT * FROM BOOKMST AS A, BOOKRENT AS B
		WHERE <!-- (B.returndate
		BETWEEN
		date_sub(NOW(),
		interval 90
		day) AND NOW())
		AND --> B.id=#{id} AND
		A.book_cd=B.book_cd AND B.rentchk='3'
		ORDER BY
		B.returndate DESC
	</select>

	<insert id="backupRecord" parameterType="BookModel">
		INSERT INTO BOOKRENT (ID, RENTDATE, BOOK_CD, RETURNDATE)
		VALUES(#{id}, #{rentdate}, #{book_cd}, #{returndate})
	</insert>

	<select id="recordListAll" resultType="BookModel">
			SELECT * FROM bookmst AS A, bookrent AS B
		WHERE <!-- (B.returndate BETWEEN
		date_sub(NOW(),
		interval 90
		day) AND NOW())
		AND  -->B.id=#{id} AND
		A.book_cd=B.book_cd AND B.rentchk='3'
		ORDER BY
		B.returndate DESC
	</select>

	<delete id="deleteRecord" parameterType="BookModel">
		DELETE 1
		FROM BOOKRENT
		WHERE book_cd=#{book_cd} AND id=#{id} AND rentchk='3'
	</delete>

</mapper>